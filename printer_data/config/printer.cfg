[include shell_command.cfg]
[include fluidd.cfg]
[virtual_sdcard]
path: /home/biqu/printer_data/gcodes
on_error_gcode: CANCEL_PRINT

# host MCU service is preinstalled and ready to use with:
[mcu CB1]
serial: /tmp/klipper_host_mcu

[include ebb36.cfg]

[include knomi.cfg]

[include eddy.cfg]

[include generic-bigtreetech-manta-m8p-V2_0.cfg]


#####################################################################
#   Macros
##################################################################### 

[gcode_macro PRINT_START]
#   Use PRINT_START for the slicer starting script - please customise for your slicer of choice
gcode:
    {% set BED_TEMP = params.BED_TEMP|default(60)|float %}
    {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(210)|float %}
    # Start bed heating (but don't wait for it) # This throws off eddy probe
    # M140 S{BED_TEMP}
    
    M190 S{BED_TEMP}               # Set and wait for bed to reach bed temp for Eddy Coil
    #M190 S110                     # Set and wait for bed to reach bed temp for Eddy Coil
    M109 S{EXTRUDER_TEMP}                # preheat extruder too

    G32                            ; prepare for printing                          
    G1 Z20 F3000                   ; move nozzle away from bed
   
    #M140 S{BED_TEMP}
    #M109 S{EXTRUDER_TEMP}          # Set and wait for nozzle to reach temperature
    PRIME_LINE                     # Pre-extrude from nozzle

[gcode_macro G32]
gcode:
    SAVE_GCODE_STATE NAME=STATE_G32
    G28                            ; home all axes
    QUAD_GANTRY_LEVEL              ; level the gantry
    BED_MESH_CALIBRATE
    #BED_MESH_CALIBRATE METHOD=scan SCAN_MODE=rapid ; Eddy fast bed level scan
    #G28                            ; home all axes
    G90                            ; absolute positioning
    RESTORE_GCODE_STATE NAME=STATE_G32

[gcode_macro PRIME_LINE]
gcode: 
    M117 Prime Line
    G92 E0 ;Reset Extruder
    # move z axis 
    G1 Z2.0 F3000 ;Move Z Axis up
    # move to prime position 
    G1 X20 Y300 Z0.28 F5000.0 ;Move to start position
    G1 X20 Y50.0 Z0.28 F1500.0 E15 ;Draw the first line
    G1 X22 Y50.0 Z0.28 F5000.0 ;Move to side a little
    G1 X22 Y300 Z0.28 F1500.0 E30 ;Draw the second line
    G92 E0 ;Reset Extruder
    G1 Z2.0 F3000 ;Move Z Axis up

[gcode_macro PRINT_END]
#   Use PRINT_END for the slicer ending script - please customise for your slicer of choice
gcode:
    # safe anti-stringing move coords
    {% set th = printer.toolhead %}
    {% set x_safe = th.position.x + 20 * (1 if th.axis_maximum.x - th.position.x > 20 else -1) %}
    {% set y_safe = th.position.y + 20 * (1 if th.axis_maximum.y - th.position.y > 20 else -1) %}
    {% set z_safe = [th.position.z + 2, th.axis_maximum.z]|min %}
    
    SAVE_GCODE_STATE NAME=STATE_PRINT_END
    
    M400                           ; wait for buffer to clear
    G92 E0                         ; zero the extruder
    G1 E-5.0 F1800                 ; retract filament
    
    TURN_OFF_HEATERS
    
    G90                                      ; absolute positioning
    G0 X{x_safe} Y{y_safe} Z{z_safe} F20000  ; move nozzle to remove stringing
    G0 X{th.axis_maximum.x//2} Y{th.axis_maximum.y - 2} F3600  ; park nozzle at rear
    M107                                     ; turn off fan
    
    BED_MESH_CLEAR
    RESTORE_GCODE_STATE NAME=STATE_PRINT_END

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [probe_eddy_current btt_eddy]
#*# reg_drive_current = 15
#*# calibrate =
#*# 	0.050000:3273433.316,0.100000:3272660.977,0.150000:3271758.230,
#*# 	0.200000:3270886.768,0.250000:3270084.940,0.300000:3269340.011,
#*# 	0.350000:3268533.930,0.400000:3267776.278,0.450000:3267041.553,
#*# 	0.500000:3266338.286,0.550000:3265574.993,0.600000:3264864.099,
#*# 	0.650000:3264176.424,0.700000:3263489.975,0.750000:3262804.555,
#*# 	0.800000:3262146.292,0.850000:3261490.216,0.900000:3260863.184,
#*# 	0.950000:3260248.818,1.000000:3259638.543,1.050000:3259025.772,
#*# 	1.100000:3258448.226,1.150000:3257889.262,1.200000:3257306.713,
#*# 	1.250000:3256722.676,1.300000:3256205.049,1.350000:3255661.849,
#*# 	1.400000:3255131.761,1.450000:3254621.541,1.500000:3254142.105,
#*# 	1.550000:3253608.437,1.600000:3253145.662,1.650000:3252659.882,
#*# 	1.700000:3252188.603,1.750000:3251736.028,1.800000:3251289.002,
#*# 	1.850000:3250844.255,1.900000:3250448.485,1.950000:3249975.312,
#*# 	2.000000:3249572.401,2.050000:3249185.906,2.100000:3248767.926,
#*# 	2.150000:3248386.772,2.200000:3248033.572,2.250000:3247634.605,
#*# 	2.300000:3247278.892,2.350000:3247013.487,2.400000:3246568.881,
#*# 	2.450000:3246190.849,2.500000:3245879.680,2.550000:3245507.818,
#*# 	2.600000:3245223.023,2.650000:3244916.748,2.700000:3244590.628,
#*# 	2.750000:3244295.292,2.800000:3243974.201,2.850000:3243705.286,
#*# 	2.900000:3243398.854,2.950000:3243141.152,3.000000:3242840.066,
#*# 	3.050000:3242511.469,3.100000:3242280.655,3.150000:3242055.596,
#*# 	3.200000:3241771.656,3.250000:3241547.000,3.300000:3241295.054,
#*# 	3.350000:3241062.165,3.400000:3240812.372,3.450000:3240565.463,
#*# 	3.500000:3240355.674,3.550000:3240111.647,3.600000:3239902.926,
#*# 	3.650000:3239678.750,3.700000:3239401.702,3.750000:3239262.614,
#*# 	3.800000:3239067.338,3.850000:3238866.223,3.900000:3238690.898,
#*# 	3.950000:3238457.576,4.000000:3238245.710,4.050000:3238127.929
#*# calibration_temp = 0.000000
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  -0.001241, 0.058314, 0.092478, 0.131707, 0.148081, 0.145365, 0.122330, 0.069868, 0.038441, -0.051478
#*# 	  -0.038403, 0.021950, 0.047075, 0.083347, 0.090183, 0.090561, 0.067084, 0.027251, -0.018500, -0.084757
#*# 	  -0.068020, -0.002138, 0.028472, 0.058427, 0.060006, 0.054277, 0.029841, -0.011290, -0.060539, -0.133075
#*# 	  -0.085840, -0.048091, -0.009605, 0.021703, 0.023020, 0.017865, -0.010496, -0.043616, -0.100387, -0.161145
#*# 	  -0.101498, -0.052369, -0.016195, 0.002775, -0.001447, -0.011461, -0.009272, -0.059306, -0.103116, -0.146402
#*# 	  -0.102788, -0.042726, -0.015187, 0.017777, 0.019796, -0.007321, -0.007822, -0.043846, -0.105823, -0.144345
#*# 	  -0.059665, -0.019228, 0.014728, 0.044408, 0.044068, 0.040952, 0.011449, -0.021923, -0.074784, -0.134461
#*# 	  -0.035536, 0.009697, 0.043633, 0.060844, 0.071818, 0.054584, 0.045534, 0.010099, -0.045082, -0.107188
#*# 	  -0.002688, 0.036909, 0.068099, 0.102136, 0.095205, 0.085783, 0.068267, 0.041662, -0.002179, -0.065435
#*# 	  -0.302340, -0.222457, -0.161180, -0.132409, -0.106905, -0.111192, -0.103479, -0.138563, -0.165216, -0.219305
#*# x_count = 10
#*# y_count = 10
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 30.0
#*# max_x = 334.92
#*# min_y = 30.0
#*# max_y = 334.92
