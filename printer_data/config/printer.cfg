[include shell_command.cfg]
[include fluidd.cfg]
[virtual_sdcard]
path: /home/biqu/printer_data/gcodes
on_error_gcode: CANCEL_PRINT

# host MCU service is preinstalled and ready to use with:
[mcu CB1]
serial: /tmp/klipper_host_mcu

[include ebb36.cfg]

[include knomi.cfg]

[include eddy.cfg]

[include generic-bigtreetech-manta-m8p-V2_0.cfg]


#####################################################################
#   Macros
##################################################################### 

[gcode_macro PRINT_START]
#   Use PRINT_START for the slicer starting script - please customise for your slicer of choice
gcode:
    {% set BED_TEMP = params.BED_TEMP|default(60)|float %}
    {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(210)|float %}
    # Start bed heating (but don't wait for it) # This throws off eddy probe
    # M140 S{BED_TEMP}
    
    M190 S{BED_TEMP}               # Set and wait for bed to reach bed temp for Eddy Coil
    #M190 S110                     # Set and wait for bed to reach bed temp for Eddy Coil
    M109 S{EXTRUDER_TEMP}                # preheat extruder too

    G32                            ; prepare for printing                          
    G1 Z20 F3000                   ; move nozzle away from bed
   
    #M140 S{BED_TEMP}
    #M109 S{EXTRUDER_TEMP}          # Set and wait for nozzle to reach temperature
    PRIME_LINE                     # Pre-extrude from nozzle

[gcode_macro G32]
gcode:
    SAVE_GCODE_STATE NAME=STATE_G32
    G28                            ; home all axes
    QUAD_GANTRY_LEVEL              ; level the gantry
    BED_MESH_CALIBRATE
    #BED_MESH_CALIBRATE METHOD=scan SCAN_MODE=rapid ; Eddy fast bed level scan
    #G28                            ; home all axes
    G90                            ; absolute positioning
    RESTORE_GCODE_STATE NAME=STATE_G32

[gcode_macro PRIME_LINE]
gcode: 
    M117 Prime Line
    G92 E0 ;Reset Extruder
    # move z axis 
    G1 Z2.0 F3000 ;Move Z Axis up
    # move to prime position 
    G1 X20 Y300 Z0.28 F5000.0 ;Move to start position
    G1 X20 Y50.0 Z0.28 F1500.0 E15 ;Draw the first line
    G1 X22 Y50.0 Z0.28 F5000.0 ;Move to side a little
    G1 X22 Y300 Z0.28 F1500.0 E30 ;Draw the second line
    G92 E0 ;Reset Extruder
    G1 Z2.0 F3000 ;Move Z Axis up

[gcode_macro PRINT_END]
#   Use PRINT_END for the slicer ending script - please customise for your slicer of choice
gcode:
    # safe anti-stringing move coords
    {% set th = printer.toolhead %}
    {% set x_safe = th.position.x + 20 * (1 if th.axis_maximum.x - th.position.x > 20 else -1) %}
    {% set y_safe = th.position.y + 20 * (1 if th.axis_maximum.y - th.position.y > 20 else -1) %}
    {% set z_safe = [th.position.z + 2, th.axis_maximum.z]|min %}
    
    SAVE_GCODE_STATE NAME=STATE_PRINT_END
    
    M400                           ; wait for buffer to clear
    G92 E0                         ; zero the extruder
    G1 E-5.0 F1800                 ; retract filament
    
    TURN_OFF_HEATERS
    
    G90                                      ; absolute positioning
    G0 X{x_safe} Y{y_safe} Z{z_safe} F20000  ; move nozzle to remove stringing
    G0 X{th.axis_maximum.x//2} Y{th.axis_maximum.y - 2} F3600  ; park nozzle at rear
    M107                                     ; turn off fan
    
    BED_MESH_CLEAR
    RESTORE_GCODE_STATE NAME=STATE_PRINT_END

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [probe_eddy_current btt_eddy]
#*# reg_drive_current = 15
#*# calibrate =
#*# 	0.050000:3267390.063,0.100000:3266662.194,0.150000:3265934.033,
#*# 	0.200000:3265236.574,0.250000:3264554.377,0.300000:3263856.468,
#*# 	0.350000:3263195.645,0.400000:3262492.055,0.450000:3261905.934,
#*# 	0.500000:3261257.775,0.550000:3260616.157,0.600000:3260026.222,
#*# 	0.650000:3259408.136,0.700000:3258783.016,0.750000:3258210.364,
#*# 	0.800000:3257641.467,0.850000:3257147.500,0.900000:3256539.480,
#*# 	0.950000:3256006.528,1.000000:3255481.785,1.050000:3254948.094,
#*# 	1.100000:3254426.279,1.150000:3253945.734,1.200000:3253456.106,
#*# 	1.250000:3252993.753,1.300000:3252530.870,1.350000:3252018.616,
#*# 	1.400000:3251583.506,1.450000:3251160.565,1.500000:3250747.771,
#*# 	1.550000:3250276.051,1.600000:3249873.256,1.650000:3249464.401,
#*# 	1.700000:3249050.857,1.750000:3248659.568,1.800000:3248221.767,
#*# 	1.850000:3247900.269,1.900000:3247558.993,1.950000:3247165.817,
#*# 	2.000000:3246778.051,2.050000:3246448.896,2.100000:3246113.988,
#*# 	2.150000:3245767.743,2.200000:3245430.124,2.250000:3245106.754,
#*# 	2.300000:3244796.515,2.350000:3244512.175,2.400000:3244212.335,
#*# 	2.450000:3243936.440,2.500000:3243617.178,2.550000:3243245.285,
#*# 	2.600000:3243054.928,2.650000:3242771.918,2.700000:3242462.603,
#*# 	2.750000:3242224.850,2.800000:3241937.615,2.850000:3241697.642,
#*# 	2.900000:3241467.724,2.950000:3241200.890,3.000000:3240979.227,
#*# 	3.050000:3240729.588,3.100000:3240471.599,3.150000:3240229.340,
#*# 	3.200000:3240063.682,3.250000:3239789.593,3.300000:3239582.563,
#*# 	3.350000:3239393.813,3.400000:3239179.346,3.450000:3238959.459,
#*# 	3.500000:3238741.309,3.550000:3238584.747,3.600000:3238361.926,
#*# 	3.650000:3238172.795,3.700000:3237983.389,3.750000:3237814.322,
#*# 	3.800000:3237633.484,3.850000:3237462.663,3.900000:3237293.879,
#*# 	3.950000:3237115.891,4.000000:3236952.106,4.050000:3236766.286
#*# calibration_temp = 0.000000
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  -0.375942, -0.318351, -0.271901, -0.241792, -0.217669, -0.216854, -0.246108, -0.286012, -0.363469, -0.423694
#*# 	  -0.433585, -0.381542, -0.321617, -0.314606, -0.291191, -0.294277, -0.325450, -0.353668, -0.411304, -0.471618
#*# 	  -0.467705, -0.416433, -0.375257, -0.326657, -0.341155, -0.347333, -0.385307, -0.411235, -0.452816, -0.533072
#*# 	  -0.516018, -0.450179, -0.407153, -0.383348, -0.377844, -0.386596, -0.415673, -0.462598, -0.481546, -0.561712
#*# 	  -0.498216, -0.453608, -0.409475, -0.403670, -0.395568, -0.398984, -0.430932, -0.458202, -0.521523, -0.571318
#*# 	  -0.510492, -0.449915, -0.411751, -0.393888, -0.383437, -0.391105, -0.414317, -0.448868, -0.497059, -0.542923
#*# 	  -0.468379, -0.424400, -0.388431, -0.357925, -0.360378, -0.379348, -0.399012, -0.428865, -0.475914, -0.558198
#*# 	  -0.438461, -0.380253, -0.334391, -0.332657, -0.316363, -0.303188, -0.346603, -0.385432, -0.450025, -0.484843
#*# 	  -0.397121, -0.338971, -0.302987, -0.282335, -0.273056, -0.277272, -0.300833, -0.334760, -0.392908, -0.436414
#*# 	  -0.460125, -0.399193, -0.352683, -0.326632, -0.308888, -0.323702, -0.335886, -0.355071, -0.416649, -0.467160
#*# x_count = 10
#*# y_count = 10
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 30.0
#*# max_x = 334.92
#*# min_y = 30.0
#*# max_y = 334.92
