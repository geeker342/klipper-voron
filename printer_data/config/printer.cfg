#[include shell_command.cfg]
[include fluidd.cfg]
[virtual_sdcard]
path: /home/biqu/printer_data/gcodes
on_error_gcode: CANCEL_PRINT

# host MCU service is preinstalled and ready to use with:
[mcu CB2]
serial: /tmp/klipper_host_mcu

[include ebb36.cfg]

[include knomi.cfg]

[include eddy.cfg]

[include generic-bigtreetech-manta-m8p-V2_0.cfg]


#####################################################################
#   Macros
##################################################################### 

[gcode_macro PRINT_START]
#   Use PRINT_START for the slicer starting script - please customise for your slicer of choice
gcode:
    {% set BED_TEMP = params.BED_TEMP|default(60)|float %}
    {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(210)|float %}
    # Start bed heating (but don't wait for it) # This throws off eddy probe
    # M140 S{BED_TEMP}
    
    M190 S{BED_TEMP}               # Set and wait for bed to reach bed temp for Eddy Coil
    #M190 S110                     # Set and wait for bed to reach bed temp for Eddy Coil
    M109 S{EXTRUDER_TEMP}                # preheat extruder too

    G32                            ; prepare for printing                          
    G1 Z20 F3000                   ; move nozzle away from bed
   
    #M140 S{BED_TEMP}
    #M109 S{EXTRUDER_TEMP}          # Set and wait for nozzle to reach temperature
    PRIME_LINE                     # Pre-extrude from nozzle

[gcode_macro G32]
gcode:
    SAVE_GCODE_STATE NAME=STATE_G32
    G28                            ; home all axes
    QUAD_GANTRY_LEVEL              ; level the gantry
    BED_MESH_CALIBRATE
    #BED_MESH_CALIBRATE METHOD=scan SCAN_MODE=rapid ; Eddy fast bed level scan
    #G28                            ; home all axes
    G90                            ; absolute positioning
    RESTORE_GCODE_STATE NAME=STATE_G32

[gcode_macro PRIME_LINE]
gcode: 
    M117 Prime Line
    G92 E0 ;Reset Extruder
    # move z axis 
    G1 Z2.0 F3000 ;Move Z Axis up
    # move to prime position 
    G1 X20 Y300 Z0.28 F5000.0 ;Move to start position
    G1 X20 Y50.0 Z0.28 F1500.0 E15 ;Draw the first line
    G1 X22 Y50.0 Z0.28 F5000.0 ;Move to side a little
    G1 X22 Y300 Z0.28 F1500.0 E30 ;Draw the second line
    G92 E0 ;Reset Extruder
    G1 Z2.0 F3000 ;Move Z Axis up

[gcode_macro PRINT_END]
#   Use PRINT_END for the slicer ending script - please customise for your slicer of choice
gcode:
    # safe anti-stringing move coords
    {% set th = printer.toolhead %}
    {% set x_safe = th.position.x + 20 * (1 if th.axis_maximum.x - th.position.x > 20 else -1) %}
    {% set y_safe = th.position.y + 20 * (1 if th.axis_maximum.y - th.position.y > 20 else -1) %}
    {% set z_safe = [th.position.z + 2, th.axis_maximum.z]|min %}
    
    SAVE_GCODE_STATE NAME=STATE_PRINT_END
    
    M400                           ; wait for buffer to clear
    G92 E0                         ; zero the extruder
    G1 E-5.0 F1800                 ; retract filament
    
    TURN_OFF_HEATERS
    
    G90                                      ; absolute positioning
    G0 X{x_safe} Y{y_safe} Z{z_safe} F20000  ; move nozzle to remove stringing
    G0 X{th.axis_maximum.x//2} Y{th.axis_maximum.y - 2} F3600  ; park nozzle at rear
    M107                                     ; turn off fan
    
    BED_MESH_CLEAR
    RESTORE_GCODE_STATE NAME=STATE_PRINT_END

[include moonraker_obico_macros.cfg]

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [probe_eddy_current btt_eddy]
#*# reg_drive_current = 16
#*# calibrate =
#*# 	0.050000:3260588.160,0.090000:3259674.359,0.130000:3258797.985,
#*# 	0.170000:3257930.173,0.210000:3257102.940,0.250000:3256265.291,
#*# 	0.290000:3255431.775,0.330000:3254655.171,0.370000:3253860.219,
#*# 	0.410000:3253091.753,0.450000:3252364.911,0.490000:3251580.584,
#*# 	0.530000:3250848.929,0.570000:3250137.331,0.610000:3249410.754,
#*# 	0.650000:3248736.087,0.690000:3248051.470,0.730000:3247359.600,
#*# 	0.770000:3246726.302,0.810000:3246053.505,0.850000:3245426.351,
#*# 	0.890000:3244829.691,0.930000:3244175.767,0.970000:3243588.185,
#*# 	1.010000:3243003.028,1.050000:3242405.117,1.090000:3241833.394,
#*# 	1.130000:3241293.935,1.170000:3240723.195,1.210000:3240206.568,
#*# 	1.250000:3239663.238,1.290000:3239136.318,1.330000:3238639.015,
#*# 	1.370000:3238119.571,1.410000:3237644.786,1.450000:3237135.914,
#*# 	1.490000:3236687.690,1.530000:3236201.957,1.570000:3235762.478,
#*# 	1.610000:3235292.703,1.650000:3234912.353,1.690000:3234434.985,
#*# 	1.730000:3234005.912,1.770000:3233572.254,1.810000:3233240.404,
#*# 	1.850000:3232811.914,1.890000:3232418.140,1.930000:3232002.806,
#*# 	1.970000:3231655.533,2.010000:3231272.460,2.050000:3230879.642,
#*# 	2.090000:3230524.900,2.130000:3230167.009,2.170000:3229822.146,
#*# 	2.210000:3229488.144,2.250000:3229150.697,2.290000:3228826.365,
#*# 	2.330000:3228498.309,2.370000:3228184.681,2.410000:3227834.185,
#*# 	2.450000:3227560.505,2.490000:3227228.256,2.530000:3226935.618,
#*# 	2.570000:3226636.119,2.610000:3226351.013,2.650000:3226040.423,
#*# 	2.690000:3225797.474,2.730000:3225527.278,2.770000:3225243.698,
#*# 	2.810000:3224950.733,2.850000:3224705.292,2.890000:3224435.155,
#*# 	2.930000:3224200.444,2.970000:3223924.354,3.010000:3223688.611,
#*# 	3.050000:3223443.012,3.090000:3223220.224,3.130000:3222962.410,
#*# 	3.170000:3222741.634,3.210000:3222497.724,3.250000:3222279.233,
#*# 	3.290000:3222050.770,3.330000:3221850.792,3.370000:3221618.623,
#*# 	3.410000:3221419.108,3.450000:3221226.995,3.490000:3221002.016,
#*# 	3.530000:3220800.120,3.570000:3220606.266,3.610000:3220414.065,
#*# 	3.650000:3220215.606,3.690000:3220061.880,3.730000:3219886.166,
#*# 	3.770000:3219643.587,3.810000:3219493.119,3.850000:3219322.931,
#*# 	3.890000:3219143.393,3.930000:3218986.761,3.970000:3218839.014,
#*# 	4.010000:3218624.309,4.050000:3218459.677
