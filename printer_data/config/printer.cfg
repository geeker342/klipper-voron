[include shell_command.cfg]
[include fluidd.cfg]
[virtual_sdcard]
path: /home/biqu/printer_data/gcodes
on_error_gcode: CANCEL_PRINT

# host MCU service is preinstalled and ready to use with:
[mcu CB1]
serial: /tmp/klipper_host_mcu

[include ebb36.cfg]

[include knomi.cfg]

[include eddy.cfg]

[include generic-bigtreetech-manta-m8p-V2_0.cfg]


#####################################################################
#   Macros
##################################################################### 

[gcode_macro PRINT_START]
#   Use PRINT_START for the slicer starting script - please customise for your slicer of choice
gcode:
    {% set BED_TEMP = params.BED_TEMP|default(60)|float %}
    {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(210)|float %}
    # Start bed heating (but don't wait for it) # This throws off eddy probe
    # M140 S{BED_TEMP}
    
    M190 S{BED_TEMP}               # Set and wait for bed to reach bed temp for Eddy Coil
    #M190 S110                     # Set and wait for bed to reach bed temp for Eddy Coil
    M109 S{EXTRUDER_TEMP}                # preheat extruder too

    G32                            ; prepare for printing                          
    G1 Z20 F3000                   ; move nozzle away from bed
   
    #M140 S{BED_TEMP}
    #M109 S{EXTRUDER_TEMP}          # Set and wait for nozzle to reach temperature
    PRIME_LINE                     # Pre-extrude from nozzle

[gcode_macro G32]
gcode:
    SAVE_GCODE_STATE NAME=STATE_G32
    G28                            ; home all axes
    QUAD_GANTRY_LEVEL              ; level the gantry
    BED_MESH_CALIBRATE
    #BED_MESH_CALIBRATE METHOD=scan SCAN_MODE=rapid ; Eddy fast bed level scan
    #G28                            ; home all axes
    G90                            ; absolute positioning
    RESTORE_GCODE_STATE NAME=STATE_G32

[gcode_macro PRIME_LINE]
gcode: 
    M117 Prime Line
    G92 E0 ;Reset Extruder
    # move z axis 
    G1 Z2.0 F3000 ;Move Z Axis up
    # move to prime position 
    G1 X20 Y300 Z0.28 F5000.0 ;Move to start position
    G1 X20 Y50.0 Z0.28 F1500.0 E15 ;Draw the first line
    G1 X22 Y50.0 Z0.28 F5000.0 ;Move to side a little
    G1 X22 Y300 Z0.28 F1500.0 E30 ;Draw the second line
    G92 E0 ;Reset Extruder
    G1 Z2.0 F3000 ;Move Z Axis up

[gcode_macro PRINT_END]
#   Use PRINT_END for the slicer ending script - please customise for your slicer of choice
gcode:
    # safe anti-stringing move coords
    {% set th = printer.toolhead %}
    {% set x_safe = th.position.x + 20 * (1 if th.axis_maximum.x - th.position.x > 20 else -1) %}
    {% set y_safe = th.position.y + 20 * (1 if th.axis_maximum.y - th.position.y > 20 else -1) %}
    {% set z_safe = [th.position.z + 2, th.axis_maximum.z]|min %}
    
    SAVE_GCODE_STATE NAME=STATE_PRINT_END
    
    M400                           ; wait for buffer to clear
    G92 E0                         ; zero the extruder
    G1 E-5.0 F1800                 ; retract filament
    
    TURN_OFF_HEATERS
    
    G90                                      ; absolute positioning
    G0 X{x_safe} Y{y_safe} Z{z_safe} F20000  ; move nozzle to remove stringing
    G0 X{th.axis_maximum.x//2} Y{th.axis_maximum.y - 2} F3600  ; park nozzle at rear
    M107                                     ; turn off fan
    
    BED_MESH_CLEAR
    RESTORE_GCODE_STATE NAME=STATE_PRINT_END

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [probe_eddy_current btt_eddy]
#*# reg_drive_current = 15
#*# calibrate =
#*# 	0.050000:3266855.153,0.100000:3266084.370,0.150000:3265268.572,
#*# 	0.200000:3264485.576,0.250000:3263789.100,0.300000:3263028.545,
#*# 	0.350000:3262445.013,0.400000:3261778.015,0.450000:3261124.164,
#*# 	0.500000:3260512.782,0.550000:3259855.160,0.600000:3259252.635,
#*# 	0.650000:3258659.903,0.700000:3258075.086,0.750000:3257503.549,
#*# 	0.800000:3256938.789,0.850000:3256380.625,0.900000:3255850.304,
#*# 	0.950000:3255313.235,1.000000:3254827.145,1.050000:3254288.424,
#*# 	1.100000:3253716.061,1.150000:3253164.539,1.200000:3252714.910,
#*# 	1.250000:3252262.889,1.300000:3251787.934,1.350000:3251352.664,
#*# 	1.400000:3250893.974,1.450000:3250427.144,1.500000:3249999.571,
#*# 	1.550000:3249571.576,1.600000:3249162.600,1.650000:3248753.081,
#*# 	1.700000:3248342.770,1.750000:3247946.349,1.800000:3247571.710,
#*# 	1.850000:3247198.875,1.900000:3246841.298,1.950000:3246443.131,
#*# 	2.000000:3246081.694,2.050000:3245748.448,2.100000:3245421.206,
#*# 	2.150000:3245082.986,2.200000:3244744.706,2.250000:3244411.732,
#*# 	2.300000:3244140.387,2.350000:3243781.729,2.400000:3243467.693,
#*# 	2.450000:3243197.241,2.500000:3242874.286,2.550000:3242569.365,
#*# 	2.600000:3242299.471,2.650000:3242017.550,2.700000:3241753.673,
#*# 	2.750000:3241523.930,2.800000:3241224.316,2.850000:3240982.327,
#*# 	2.900000:3240719.614,2.950000:3240480.768,3.000000:3240234.959,
#*# 	3.050000:3239991.614,3.100000:3239771.535,3.150000:3239517.501,
#*# 	3.200000:3239327.984,3.250000:3239041.817,3.300000:3238893.941,
#*# 	3.350000:3238666.317,3.400000:3238474.053,3.450000:3238255.032,
#*# 	3.500000:3238050.716,3.550000:3237817.572,3.600000:3237641.277,
#*# 	3.650000:3237485.746,3.700000:3237265.878,3.750000:3237078.399,
#*# 	3.800000:3236958.636,3.850000:3236747.394,3.900000:3236584.618,
#*# 	3.950000:3236385.871,4.000000:3236243.969,4.050000:3236064.396
#*# calibration_temp = 0.000000
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  -0.448225, -0.387741, -0.315173, -0.294394, -0.274550, -0.279134, -0.300277, -0.375295, -0.426919, -0.502745
#*# 	  -0.477825, -0.421453, -0.370861, -0.342520, -0.325856, -0.314869, -0.341456, -0.376812, -0.420392, -0.489945
#*# 	  -0.492206, -0.451158, -0.411449, -0.381916, -0.357515, -0.363359, -0.379938, -0.421580, -0.468936, -0.531733
#*# 	  -0.548108, -0.496764, -0.449178, -0.401099, -0.396124, -0.402027, -0.436576, -0.471532, -0.510369, -0.557499
#*# 	  -0.535041, -0.489601, -0.447858, -0.422420, -0.427412, -0.419798, -0.444707, -0.479436, -0.519057, -0.547322
#*# 	  -0.527521, -0.478595, -0.452306, -0.430467, -0.412859, -0.417397, -0.429085, -0.479505, -0.519001, -0.550785
#*# 	  -0.511119, -0.458012, -0.426864, -0.384062, -0.399165, -0.392503, -0.430861, -0.460950, -0.496529, -0.547378
#*# 	  -0.485868, -0.436343, -0.404727, -0.382722, -0.370981, -0.376705, -0.413820, -0.425773, -0.478665, -0.523441
#*# 	  -0.453569, -0.399308, -0.360119, -0.350254, -0.336561, -0.332322, -0.363912, -0.408712, -0.433681, -0.493559
#*# 	  -0.605632, -0.537661, -0.506850, -0.459351, -0.457484, -0.463799, -0.469436, -0.484506, -0.520241, -0.594635
#*# x_count = 10
#*# y_count = 10
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 30.0
#*# max_x = 334.92
#*# min_y = 30.0
#*# max_y = 334.92
