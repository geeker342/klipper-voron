[include shell_command.cfg]
[include fluidd.cfg]
[virtual_sdcard]
path: /home/biqu/printer_data/gcodes
on_error_gcode: CANCEL_PRINT

# host MCU service is preinstalled and ready to use with:
[mcu CB1]
serial: /tmp/klipper_host_mcu

[include ebb36.cfg]

[include knomi.cfg]

[include eddy.cfg]

[include generic-bigtreetech-manta-m8p-V2_0.cfg]


#####################################################################
#   Macros
##################################################################### 

[gcode_macro PRINT_START]
#   Use PRINT_START for the slicer starting script - please customise for your slicer of choice
gcode:
    {% set BED_TEMP = params.BED_TEMP|default(60)|float %}
    {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(210)|float %}
    # Start bed heating (but don't wait for it) # This throws off eddy probe
    # M140 S{BED_TEMP}
    
    M190 S{BED_TEMP}               # Set and wait for bed to reach bed temp for Eddy Coil
    #M190 S110                     # Set and wait for bed to reach bed temp for Eddy Coil
    M109 S{EXTRUDER_TEMP}                # preheat extruder too

    G32                            ; prepare for printing                          
    G1 Z20 F3000                   ; move nozzle away from bed
   
    #M140 S{BED_TEMP}
    #M109 S{EXTRUDER_TEMP}          # Set and wait for nozzle to reach temperature
    PRIME_LINE                     # Pre-extrude from nozzle

[gcode_macro G32]
gcode:
    SAVE_GCODE_STATE NAME=STATE_G32
    G28                            ; home all axes
    QUAD_GANTRY_LEVEL              ; level the gantry
    BED_MESH_CALIBRATE
    #BED_MESH_CALIBRATE METHOD=scan SCAN_MODE=rapid ; Eddy fast bed level scan
    #G28                            ; home all axes
    G90                            ; absolute positioning
    RESTORE_GCODE_STATE NAME=STATE_G32

[gcode_macro PRIME_LINE]
gcode: 
    M117 Prime Line
    G92 E0 ;Reset Extruder
    # move z axis 
    G1 Z2.0 F3000 ;Move Z Axis up
    # move to prime position 
    G1 X20 Y300 Z0.28 F5000.0 ;Move to start position
    G1 X20 Y50.0 Z0.28 F1500.0 E15 ;Draw the first line
    G1 X22 Y50.0 Z0.28 F5000.0 ;Move to side a little
    G1 X22 Y300 Z0.28 F1500.0 E30 ;Draw the second line
    G92 E0 ;Reset Extruder
    G1 Z2.0 F3000 ;Move Z Axis up

[gcode_macro PRINT_END]
#   Use PRINT_END for the slicer ending script - please customise for your slicer of choice
gcode:
    # safe anti-stringing move coords
    {% set th = printer.toolhead %}
    {% set x_safe = th.position.x + 20 * (1 if th.axis_maximum.x - th.position.x > 20 else -1) %}
    {% set y_safe = th.position.y + 20 * (1 if th.axis_maximum.y - th.position.y > 20 else -1) %}
    {% set z_safe = [th.position.z + 2, th.axis_maximum.z]|min %}
    
    SAVE_GCODE_STATE NAME=STATE_PRINT_END
    
    M400                           ; wait for buffer to clear
    G92 E0                         ; zero the extruder
    G1 E-5.0 F1800                 ; retract filament
    
    TURN_OFF_HEATERS
    
    G90                                      ; absolute positioning
    G0 X{x_safe} Y{y_safe} Z{z_safe} F20000  ; move nozzle to remove stringing
    G0 X{th.axis_maximum.x//2} Y{th.axis_maximum.y - 2} F3600  ; park nozzle at rear
    M107                                     ; turn off fan
    
    BED_MESH_CLEAR
    RESTORE_GCODE_STATE NAME=STATE_PRINT_END

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [probe_eddy_current btt_eddy]
#*# reg_drive_current = 15
#*# calibrate =
#*# 	0.050000:3270804.858,0.100000:3270195.401,0.150000:3269370.876,
#*# 	0.200000:3268576.790,0.250000:3267842.075,0.300000:3267051.506,
#*# 	0.350000:3266374.201,0.400000:3265705.818,0.450000:3264976.013,
#*# 	0.500000:3264293.306,0.550000:3263580.277,0.600000:3262835.985,
#*# 	0.650000:3262287.548,0.700000:3261606.286,0.750000:3261019.335,
#*# 	0.800000:3260354.370,0.850000:3259730.500,0.900000:3259149.538,
#*# 	0.950000:3258558.402,1.000000:3257976.912,1.050000:3257395.609,
#*# 	1.100000:3256824.959,1.150000:3256279.787,1.200000:3255720.835,
#*# 	1.250000:3255250.221,1.300000:3254691.997,1.350000:3254168.890,
#*# 	1.400000:3253688.214,1.450000:3253189.256,1.500000:3252706.201,
#*# 	1.550000:3252248.938,1.600000:3251773.265,1.650000:3251312.906,
#*# 	1.700000:3250943.563,1.750000:3250444.027,1.800000:3250010.344,
#*# 	1.850000:3249607.986,1.900000:3249186.531,1.950000:3248797.630,
#*# 	2.000000:3248402.045,2.050000:3247993.061,2.100000:3247635.557,
#*# 	2.150000:3247255.600,2.200000:3246900.486,2.250000:3246595.456,
#*# 	2.300000:3246205.128,2.350000:3245834.235,2.400000:3245490.603,
#*# 	2.450000:3245153.843,2.500000:3244858.748,2.550000:3244540.465,
#*# 	2.600000:3244224.203,2.650000:3243904.412,2.700000:3243623.991,
#*# 	2.750000:3243310.295,2.800000:3243015.228,2.850000:3242754.519,
#*# 	2.900000:3242466.980,2.950000:3242238.276,3.000000:3241918.186,
#*# 	3.050000:3241675.251,3.100000:3241411.266,3.150000:3241136.569,
#*# 	3.200000:3240888.582,3.250000:3240657.574,3.300000:3240430.440,
#*# 	3.350000:3240179.107,3.400000:3239950.986,3.450000:3239722.551,
#*# 	3.500000:3239500.719,3.550000:3239298.484,3.600000:3239055.683,
#*# 	3.650000:3238849.982,3.700000:3238664.197,3.750000:3238448.670,
#*# 	3.800000:3238244.098,3.850000:3238060.666,3.900000:3237876.964,
#*# 	3.950000:3237669.963,4.000000:3237507.537,4.050000:3237319.032
#*# calibration_temp = 0.000000
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  -0.001044, 0.028088, 0.096353, 0.134757, 0.129719, 0.124450, 0.113975, 0.070845, 0.000858, -0.063365
#*# 	  -0.052606, 0.004121, 0.048704, 0.065751, 0.086333, 0.080522, 0.063469, 0.017507, -0.030875, -0.115520
#*# 	  -0.078708, -0.031919, 0.008431, 0.034414, 0.052623, 0.046022, 0.024331, -0.025972, -0.088990, -0.154113
#*# 	  -0.112072, -0.031178, -0.022739, 0.005411, 0.021977, 0.010332, -0.038056, -0.040233, -0.115835, -0.168098
#*# 	  -0.107220, -0.060795, -0.036613, -0.004357, -0.014469, -0.014383, -0.032024, -0.079046, -0.120473, -0.135159
#*# 	  -0.097231, -0.057784, -0.023326, 0.005974, 0.004864, -0.001622, -0.017961, -0.066447, -0.109637, -0.144686
#*# 	  -0.079625, -0.035622, -0.004118, 0.021903, 0.039921, 0.018478, -0.000840, -0.022040, -0.107429, -0.162698
#*# 	  -0.049970, -0.016399, 0.035619, 0.040361, 0.044880, 0.034200, 0.017484, 0.010098, -0.058028, -0.120084
#*# 	  -0.027098, 0.023840, 0.055859, 0.083223, 0.080423, 0.080408, 0.053465, 0.022287, -0.018350, -0.081135
#*# 	  -0.340032, -0.278035, -0.197229, -0.156871, -0.146135, -0.129590, -0.139065, -0.151957, -0.186988, -0.231687
#*# x_count = 10
#*# y_count = 10
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 30.0
#*# max_x = 334.92
#*# min_y = 30.0
#*# max_y = 334.92
