#[include shell_command.cfg]
[include fluidd.cfg]
[virtual_sdcard]
path: /home/biqu/printer_data/gcodes
on_error_gcode: CANCEL_PRINT

# host MCU service is preinstalled and ready to use with:
[mcu CB1]
serial: /tmp/klipper_host_mcu

[include ebb36.cfg]

[include knomi.cfg]

[include eddy.cfg]

[include generic-bigtreetech-manta-m8p-V2_0.cfg]


#####################################################################
#   Macros
##################################################################### 

[gcode_macro PRINT_START]
#   Use PRINT_START for the slicer starting script - please customise for your slicer of choice
gcode:
    {% set BED_TEMP = params.BED_TEMP|default(60)|float %}
    {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(210)|float %}
    # Start bed heating (but don't wait for it) # This throws off eddy probe
    # M140 S{BED_TEMP}
    
    M190 S{BED_TEMP}               # Set and wait for bed to reach bed temp for Eddy Coil
    #M190 S110                     # Set and wait for bed to reach bed temp for Eddy Coil
    M109 S{EXTRUDER_TEMP}                # preheat extruder too

    G32                            ; prepare for printing                          
    G1 Z20 F3000                   ; move nozzle away from bed
   
    #M140 S{BED_TEMP}
    #M109 S{EXTRUDER_TEMP}          # Set and wait for nozzle to reach temperature
    PRIME_LINE                     # Pre-extrude from nozzle

[gcode_macro G32]
gcode:
    SAVE_GCODE_STATE NAME=STATE_G32
    G28                            ; home all axes
    QUAD_GANTRY_LEVEL              ; level the gantry
    BED_MESH_CALIBRATE
    #BED_MESH_CALIBRATE METHOD=scan SCAN_MODE=rapid ; Eddy fast bed level scan
    #G28                            ; home all axes
    G90                            ; absolute positioning
    RESTORE_GCODE_STATE NAME=STATE_G32

[gcode_macro PRIME_LINE]
gcode: 
    M117 Prime Line
    G92 E0 ;Reset Extruder
    # move z axis 
    G1 Z2.0 F3000 ;Move Z Axis up
    # move to prime position 
    G1 X20 Y300 Z0.28 F5000.0 ;Move to start position
    G1 X20 Y50.0 Z0.28 F1500.0 E15 ;Draw the first line
    G1 X22 Y50.0 Z0.28 F5000.0 ;Move to side a little
    G1 X22 Y300 Z0.28 F1500.0 E30 ;Draw the second line
    G92 E0 ;Reset Extruder
    G1 Z2.0 F3000 ;Move Z Axis up

[gcode_macro PRINT_END]
#   Use PRINT_END for the slicer ending script - please customise for your slicer of choice
gcode:
    # safe anti-stringing move coords
    {% set th = printer.toolhead %}
    {% set x_safe = th.position.x + 20 * (1 if th.axis_maximum.x - th.position.x > 20 else -1) %}
    {% set y_safe = th.position.y + 20 * (1 if th.axis_maximum.y - th.position.y > 20 else -1) %}
    {% set z_safe = [th.position.z + 2, th.axis_maximum.z]|min %}
    
    SAVE_GCODE_STATE NAME=STATE_PRINT_END
    
    M400                           ; wait for buffer to clear
    G92 E0                         ; zero the extruder
    G1 E-5.0 F1800                 ; retract filament
    
    TURN_OFF_HEATERS
    
    G90                                      ; absolute positioning
    G0 X{x_safe} Y{y_safe} Z{z_safe} F20000  ; move nozzle to remove stringing
    G0 X{th.axis_maximum.x//2} Y{th.axis_maximum.y - 2} F3600  ; park nozzle at rear
    M107                                     ; turn off fan
    
    BED_MESH_CLEAR
    RESTORE_GCODE_STATE NAME=STATE_PRINT_END

[include moonraker_obico_macros.cfg]
#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [probe_eddy_current btt_eddy]
#*# reg_drive_current = 15
#*# calibrate =
#*# 	0.050000:3269935.236,0.100000:3269157.782,0.150000:3268347.520,
#*# 	0.200000:3267565.452,0.250000:3266909.419,0.300000:3266175.609,
#*# 	0.350000:3265456.038,0.400000:3264726.404,0.450000:3264063.166,
#*# 	0.500000:3263325.676,0.550000:3262653.607,0.600000:3261977.767,
#*# 	0.650000:3261363.654,0.700000:3260710.377,0.750000:3260096.294,
#*# 	0.800000:3259470.257,0.850000:3258869.669,0.900000:3258259.704,
#*# 	0.950000:3257692.423,1.000000:3257074.712,1.050000:3256519.360,
#*# 	1.100000:3255954.605,1.150000:3255436.098,1.200000:3254938.909,
#*# 	1.250000:3254380.529,1.300000:3253940.933,1.350000:3253396.943,
#*# 	1.400000:3252923.643,1.450000:3252424.952,1.500000:3251958.929,
#*# 	1.550000:3251466.809,1.600000:3251087.221,1.650000:3250587.180,
#*# 	1.700000:3250168.159,1.750000:3249743.947,1.800000:3249312.613,
#*# 	1.850000:3248954.757,1.900000:3248527.079,1.950000:3248082.867,
#*# 	2.000000:3247754.643,2.050000:3247351.574,2.100000:3247000.683,
#*# 	2.150000:3246644.434,2.200000:3246263.327,2.250000:3245924.021,
#*# 	2.300000:3245617.641,2.350000:3245269.158,2.400000:3244964.949,
#*# 	2.450000:3244616.222,2.500000:3244313.077,2.550000:3243997.473,
#*# 	2.600000:3243648.013,2.650000:3243384.347,2.700000:3243097.077,
#*# 	2.750000:3242833.342,2.800000:3242523.214,2.850000:3242251.982,
#*# 	2.900000:3241986.252,2.950000:3241711.531,3.000000:3241472.127,
#*# 	3.050000:3241210.610,3.100000:3240933.551,3.150000:3240700.315,
#*# 	3.200000:3240454.568,3.250000:3240228.173,3.300000:3239972.201,
#*# 	3.350000:3239779.939,3.400000:3239584.531,3.450000:3239341.970,
#*# 	3.500000:3239118.599,3.550000:3238918.860,3.600000:3238716.801,
#*# 	3.650000:3238497.679,3.700000:3238303.038,3.750000:3238138.322,
#*# 	3.800000:3237929.347,3.850000:3237726.544,3.900000:3237544.008,
#*# 	3.950000:3237364.131,4.000000:3237196.235,4.050000:3237011.843
#*# calibration_temp = 0.000000
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  -0.090948, -0.035735, 0.008761, 0.044482, 0.062129, 0.054484, 0.043127, -0.006325, -0.038012, -0.134682
#*# 	  -0.137444, -0.068648, -0.029889, -0.008806, 0.009323, 0.010236, -0.018458, -0.055084, -0.097829, -0.181284
#*# 	  -0.168500, -0.097513, -0.063373, -0.043655, -0.025925, -0.045185, -0.063871, -0.108804, -0.156325, -0.235333
#*# 	  -0.193801, -0.134620, -0.098047, -0.074937, -0.063462, -0.079764, -0.095551, -0.127580, -0.186557, -0.254834
#*# 	  -0.178875, -0.146137, -0.091084, -0.083708, -0.084950, -0.088371, -0.097935, -0.156163, -0.211497, -0.224279
#*# 	  -0.176290, -0.120343, -0.105926, -0.076599, -0.063644, -0.077709, -0.101612, -0.149264, -0.186536, -0.229415
#*# 	  -0.143737, -0.111134, -0.067331, -0.047376, -0.048330, -0.067223, -0.094306, -0.119310, -0.159459, -0.237928
#*# 	  -0.119718, -0.080968, -0.059024, -0.020844, -0.024844, -0.037805, -0.042462, -0.096266, -0.131523, -0.188555
#*# 	  -0.087368, -0.044988, -0.028493, 0.008611, 0.005640, -0.011669, -0.031273, -0.064935, -0.088137, -0.196487
#*# 	  -0.446174, -0.377072, -0.304468, -0.264271, -0.240909, -0.240238, -0.250090, -0.270121, -0.305639, -0.325618
#*# x_count = 10
#*# y_count = 10
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 30.0
#*# max_x = 334.92
#*# min_y = 30.0
#*# max_y = 334.92
