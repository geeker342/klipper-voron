[include shell_command.cfg]
[include fluidd.cfg]
[virtual_sdcard]
path: /home/biqu/printer_data/gcodes
on_error_gcode: CANCEL_PRINT

# host MCU service is preinstalled and ready to use with:
[mcu CB1]
serial: /tmp/klipper_host_mcu

[include ebb36.cfg]


[include knomi.cfg]

[include eddy.cfg]


[include generic-bigtreetech-manta-m8p-V2_0.cfg]


#####################################################################
#   Macros
##################################################################### 

[gcode_macro PRINT_START]
#   Use PRINT_START for the slicer starting script - please customise for your slicer of choice
gcode:
    {% set BED_TEMP = params.BED_TEMP|default(60)|float %}
    {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(210)|float %}
    # Start bed heating (but don't wait for it) # This throws off eddy probe
    # M140 S{BED_TEMP}
    
    M190 S{BED_TEMP}               # Set and wait for bed to reach bed temp for Eddy Coil
    #M190 S110                     # Set and wait for bed to reach bed temp for Eddy Coil
    M109 S{EXTRUDER_TEMP}                # preheat extruder too

    G32                            ; prepare for printing                          
    G1 Z20 F3000                   ; move nozzle away from bed
   
    #M140 S{BED_TEMP}
    #M109 S{EXTRUDER_TEMP}          # Set and wait for nozzle to reach temperature
    PRIME_LINE                     # Pre-extrude from nozzle

[gcode_macro G32]
gcode:
    SAVE_GCODE_STATE NAME=STATE_G32
    G28                            ; home all axes
    QUAD_GANTRY_LEVEL              ; level the gantry
    BED_MESH_CALIBRATE
    #BED_MESH_CALIBRATE METHOD=scan SCAN_MODE=rapid ; Eddy fast bed level scan
    #G28                            ; home all axes
    G90                            ; absolute positioning
    RESTORE_GCODE_STATE NAME=STATE_G32

[gcode_macro PRIME_LINE]
gcode: 
    M117 Prime Line
    G92 E0 ;Reset Extruder
    # move z axis 
    G1 Z2.0 F3000 ;Move Z Axis up
    # move to prime position 
    G1 X20 Y300 Z0.28 F5000.0 ;Move to start position
    G1 X20 Y50.0 Z0.28 F1500.0 E15 ;Draw the first line
    G1 X22 Y50.0 Z0.28 F5000.0 ;Move to side a little
    G1 X22 Y300 Z0.28 F1500.0 E30 ;Draw the second line
    G92 E0 ;Reset Extruder
    G1 Z2.0 F3000 ;Move Z Axis up

[gcode_macro PRINT_END]
#   Use PRINT_END for the slicer ending script - please customise for your slicer of choice
gcode:
    # safe anti-stringing move coords
    {% set th = printer.toolhead %}
    {% set x_safe = th.position.x + 20 * (1 if th.axis_maximum.x - th.position.x > 20 else -1) %}
    {% set y_safe = th.position.y + 20 * (1 if th.axis_maximum.y - th.position.y > 20 else -1) %}
    {% set z_safe = [th.position.z + 2, th.axis_maximum.z]|min %}
    
    SAVE_GCODE_STATE NAME=STATE_PRINT_END
    
    M400                           ; wait for buffer to clear
    G92 E0                         ; zero the extruder
    G1 E-5.0 F1800                 ; retract filament
    
    TURN_OFF_HEATERS
    
    G90                                      ; absolute positioning
    G0 X{x_safe} Y{y_safe} Z{z_safe} F20000  ; move nozzle to remove stringing
    G0 X{th.axis_maximum.x//2} Y{th.axis_maximum.y - 2} F3600  ; park nozzle at rear
    M107                                     ; turn off fan
    
    BED_MESH_CLEAR
    RESTORE_GCODE_STATE NAME=STATE_PRINT_END

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [probe_eddy_current btt_eddy]
#*# reg_drive_current = 15
#*# calibrate =
#*# 	0.050000:3268425.285,0.100000:3267693.862,0.150000:3266901.596,
#*# 	0.200000:3266189.250,0.250000:3265466.585,0.300000:3264760.508,
#*# 	0.350000:3264057.769,0.400000:3263347.700,0.450000:3262693.416,
#*# 	0.500000:3262061.936,0.550000:3261397.802,0.600000:3260760.444,
#*# 	0.650000:3260123.354,0.700000:3259529.319,0.750000:3258908.728,
#*# 	0.800000:3258331.902,0.850000:3257756.509,0.900000:3257154.693,
#*# 	0.950000:3256616.584,1.000000:3256077.002,1.050000:3255542.667,
#*# 	1.100000:3255022.716,1.150000:3254497.598,1.200000:3253984.453,
#*# 	1.250000:3253495.697,1.300000:3253017.113,1.350000:3252542.651,
#*# 	1.400000:3252062.014,1.450000:3251615.879,1.500000:3251158.027,
#*# 	1.550000:3250714.910,1.600000:3250297.652,1.650000:3249869.933,
#*# 	1.700000:3249456.188,1.750000:3249038.211,1.800000:3248613.695,
#*# 	1.850000:3248231.680,1.900000:3247823.221,1.950000:3247467.915,
#*# 	2.000000:3247119.784,2.050000:3246740.168,2.100000:3246374.390,
#*# 	2.150000:3246018.897,2.200000:3245701.787,2.250000:3245341.148,
#*# 	2.300000:3245007.501,2.350000:3244697.085,2.400000:3244406.607,
#*# 	2.450000:3244089.181,2.500000:3243746.598,2.550000:3243467.223,
#*# 	2.600000:3243194.250,2.650000:3242893.439,2.700000:3242622.465,
#*# 	2.750000:3242343.544,2.800000:3242050.782,2.850000:3241804.848,
#*# 	2.900000:3241517.488,2.950000:3241286.847,3.000000:3241021.473,
#*# 	3.050000:3240771.013,3.100000:3240545.031,3.150000:3240295.321,
#*# 	3.200000:3240082.501,3.250000:3239851.789,3.300000:3239615.905,
#*# 	3.350000:3239412.451,3.400000:3239172.777,3.450000:3238976.574,
#*# 	3.500000:3238775.383,3.550000:3238582.474,3.600000:3238362.343,
#*# 	3.650000:3238160.742,3.700000:3237978.033,3.750000:3237805.721,
#*# 	3.800000:3237585.600,3.850000:3237439.361,3.900000:3237263.718,
#*# 	3.950000:3237059.179,4.000000:3236892.738,4.050000:3236729.214
#*# calibration_temp = 0.000000
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  -0.673372, -0.643508, -0.568204, -0.532639, -0.517833, -0.530215, -0.547181, -0.617044, -0.683239, -0.758240
#*# 	  -0.724556, -0.651596, -0.595249, -0.572915, -0.572726, -0.548348, -0.598908, -0.617335, -0.673827, -0.775173
#*# 	  -0.759959, -0.694015, -0.638771, -0.622611, -0.612835, -0.608082, -0.641072, -0.665592, -0.741050, -0.826679
#*# 	  -0.784179, -0.727351, -0.698674, -0.661599, -0.669426, -0.653101, -0.668841, -0.726433, -0.756299, -0.854126
#*# 	  -0.799441, -0.749080, -0.690777, -0.664953, -0.669426, -0.663128, -0.712864, -0.712268, -0.778101, -0.844504
#*# 	  -0.770497, -0.722790, -0.717586, -0.658338, -0.666914, -0.675241, -0.707347, -0.728869, -0.783655, -0.827323
#*# 	  -0.772589, -0.710037, -0.651627, -0.649209, -0.638412, -0.654534, -0.674186, -0.689243, -0.774265, -0.854379
#*# 	  -0.731928, -0.678703, -0.641802, -0.631764, -0.616762, -0.628685, -0.640260, -0.663960, -0.733151, -0.798809
#*# 	  -0.714581, -0.643747, -0.611736, -0.584836, -0.565977, -0.571847, -0.590177, -0.643760, -0.671011, -0.773476
#*# 	  -0.864677, -0.771561, -0.730288, -0.698868, -0.705210, -0.696796, -0.730747, -0.752581, -0.793758, -0.857609
#*# x_count = 10
#*# y_count = 10
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 30.0
#*# max_x = 334.92
#*# min_y = 30.0
#*# max_y = 334.92
