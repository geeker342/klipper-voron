[include shell_command.cfg]
[include fluidd.cfg]
[virtual_sdcard]
path: /home/biqu/printer_data/gcodes
on_error_gcode: CANCEL_PRINT

# host MCU service is preinstalled and ready to use with:
[mcu CB1]
serial: /tmp/klipper_host_mcu

[include ebb36.cfg]

[include knomi.cfg]

[include eddy.cfg]

[include generic-bigtreetech-manta-m8p-V2_0.cfg]


#####################################################################
#   Macros
##################################################################### 

[gcode_macro PRINT_START]
#   Use PRINT_START for the slicer starting script - please customise for your slicer of choice
gcode:
    {% set BED_TEMP = params.BED_TEMP|default(60)|float %}
    {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(210)|float %}
    # Start bed heating (but don't wait for it) # This throws off eddy probe
    # M140 S{BED_TEMP}
    
    M190 S{BED_TEMP}               # Set and wait for bed to reach bed temp for Eddy Coil
    #M190 S110                     # Set and wait for bed to reach bed temp for Eddy Coil
    M109 S{EXTRUDER_TEMP}                # preheat extruder too

    G32                            ; prepare for printing                          
    G1 Z20 F3000                   ; move nozzle away from bed
   
    #M140 S{BED_TEMP}
    #M109 S{EXTRUDER_TEMP}          # Set and wait for nozzle to reach temperature
    PRIME_LINE                     # Pre-extrude from nozzle

[gcode_macro G32]
gcode:
    SAVE_GCODE_STATE NAME=STATE_G32
    G28                            ; home all axes
    QUAD_GANTRY_LEVEL              ; level the gantry
    BED_MESH_CALIBRATE
    #BED_MESH_CALIBRATE METHOD=scan SCAN_MODE=rapid ; Eddy fast bed level scan
    #G28                            ; home all axes
    G90                            ; absolute positioning
    RESTORE_GCODE_STATE NAME=STATE_G32

[gcode_macro PRIME_LINE]
gcode: 
    M117 Prime Line
    G92 E0 ;Reset Extruder
    # move z axis 
    G1 Z2.0 F3000 ;Move Z Axis up
    # move to prime position 
    G1 X20 Y300 Z0.28 F5000.0 ;Move to start position
    G1 X20 Y50.0 Z0.28 F1500.0 E15 ;Draw the first line
    G1 X22 Y50.0 Z0.28 F5000.0 ;Move to side a little
    G1 X22 Y300 Z0.28 F1500.0 E30 ;Draw the second line
    G92 E0 ;Reset Extruder
    G1 Z2.0 F3000 ;Move Z Axis up

[gcode_macro PRINT_END]
#   Use PRINT_END for the slicer ending script - please customise for your slicer of choice
gcode:
    # safe anti-stringing move coords
    {% set th = printer.toolhead %}
    {% set x_safe = th.position.x + 20 * (1 if th.axis_maximum.x - th.position.x > 20 else -1) %}
    {% set y_safe = th.position.y + 20 * (1 if th.axis_maximum.y - th.position.y > 20 else -1) %}
    {% set z_safe = [th.position.z + 2, th.axis_maximum.z]|min %}
    
    SAVE_GCODE_STATE NAME=STATE_PRINT_END
    
    M400                           ; wait for buffer to clear
    G92 E0                         ; zero the extruder
    G1 E-5.0 F1800                 ; retract filament
    
    TURN_OFF_HEATERS
    
    G90                                      ; absolute positioning
    G0 X{x_safe} Y{y_safe} Z{z_safe} F20000  ; move nozzle to remove stringing
    G0 X{th.axis_maximum.x//2} Y{th.axis_maximum.y - 2} F3600  ; park nozzle at rear
    M107                                     ; turn off fan
    
    BED_MESH_CLEAR
    RESTORE_GCODE_STATE NAME=STATE_PRINT_END

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [probe_eddy_current btt_eddy]
#*# reg_drive_current = 15
#*# calibrate =
#*# 	0.050000:3267720.036,0.100000:3266954.066,0.150000:3266234.620,
#*# 	0.200000:3265527.480,0.250000:3264845.175,0.300000:3264076.618,
#*# 	0.350000:3263464.555,0.400000:3262726.133,0.450000:3262161.584,
#*# 	0.500000:3261468.789,0.550000:3260836.595,0.600000:3260211.108,
#*# 	0.650000:3259629.917,0.700000:3259011.755,0.750000:3258392.765,
#*# 	0.800000:3257840.081,0.850000:3257289.999,0.900000:3256735.291,
#*# 	0.950000:3256175.454,1.000000:3255672.508,1.050000:3255132.108,
#*# 	1.100000:3254648.333,1.150000:3254101.707,1.200000:3253588.016,
#*# 	1.250000:3253092.272,1.300000:3252610.129,1.350000:3252167.165,
#*# 	1.400000:3251686.627,1.450000:3251241.584,1.500000:3250826.130,
#*# 	1.550000:3250358.229,1.600000:3249918.134,1.650000:3249557.428,
#*# 	1.700000:3249112.682,1.750000:3248731.555,1.800000:3248287.015,
#*# 	1.850000:3247938.930,1.900000:3247594.957,1.950000:3247180.369,
#*# 	2.000000:3246852.643,2.050000:3246453.798,2.100000:3246111.983,
#*# 	2.150000:3245782.398,2.200000:3245425.889,2.250000:3245125.734,
#*# 	2.300000:3244803.326,2.350000:3244463.746,2.400000:3244177.587,
#*# 	2.450000:3243856.047,2.500000:3243563.523,2.550000:3243289.512,
#*# 	2.600000:3242970.068,2.650000:3242693.355,2.700000:3242403.786,
#*# 	2.750000:3242139.340,2.800000:3241895.197,2.850000:3241589.311,
#*# 	2.900000:3241358.728,2.950000:3241061.098,3.000000:3240840.269,
#*# 	3.050000:3240593.103,3.100000:3240367.013,3.150000:3240118.098,
#*# 	3.200000:3239903.084,3.250000:3239679.766,3.300000:3239452.902,
#*# 	3.350000:3239247.121,3.400000:3239020.220,3.450000:3238809.548,
#*# 	3.500000:3238631.920,3.550000:3238382.020,3.600000:3238228.983,
#*# 	3.650000:3238015.454,3.700000:3237810.866,3.750000:3237647.029,
#*# 	3.800000:3237458.937,3.850000:3237298.329,3.900000:3237099.204,
#*# 	3.950000:3236935.547,4.000000:3236761.267,4.050000:3236612.772
#*# calibration_temp = 0.000000
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  -0.018401, 0.023422, 0.079847, 0.114625, 0.127414, 0.117906, 0.101301, 0.065296, -0.003340, -0.080648
#*# 	  -0.073190, -0.026802, 0.026417, 0.059914, 0.064016, 0.059021, 0.042576, 0.008719, -0.042046, -0.108340
#*# 	  -0.102029, -0.050052, 0.005024, 0.024221, 0.014486, 0.025130, 0.004674, -0.019949, -0.081908, -0.158834
#*# 	  -0.130915, -0.080378, -0.039560, -0.007884, -0.008901, -0.021517, -0.040049, -0.068626, -0.130104, -0.194477
#*# 	  -0.139745, -0.096956, -0.041642, -0.025610, -0.013870, -0.042690, -0.057146, -0.102648, -0.132045, -0.172957
#*# 	  -0.125376, -0.068764, -0.041602, -0.010136, 0.005959, -0.026524, -0.035186, -0.076964, -0.105195, -0.156240
#*# 	  -0.105191, -0.064598, -0.016908, 0.005991, 0.009802, -0.002394, -0.012305, -0.026535, -0.110519, -0.175744
#*# 	  -0.073042, -0.024125, 0.030665, 0.049396, 0.052829, 0.035253, 0.019427, -0.015521, -0.074981, -0.122693
#*# 	  -0.023468, 0.027237, 0.059266, 0.084155, 0.086203, 0.082587, 0.059430, 0.017758, -0.005949, -0.070899
#*# 	  -0.241585, -0.162288, -0.108529, -0.080293, -0.060048, -0.046518, -0.069707, -0.083207, -0.100823, -0.172657
#*# x_count = 10
#*# y_count = 10
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 30.0
#*# max_x = 334.92
#*# min_y = 30.0
#*# max_y = 334.92
