#[include shell_command.cfg]
[include fluidd.cfg]
[virtual_sdcard]
path: /home/biqu/printer_data/gcodes
on_error_gcode: CANCEL_PRINT

# host MCU service is preinstalled and ready to use with:
[mcu CB2]
serial: /tmp/klipper_host_mcu

[include ebb36.cfg]

[include knomi.cfg]

[include eddy_zoffset.cfg]

[include generic-bigtreetech-manta-m8p-V2_0.cfg]


#####################################################################
#   Macros
##################################################################### 

[gcode_macro PRINT_START]
#   Use PRINT_START for the slicer starting script - please customise for your slicer of choice
gcode:
    {% set BED_TEMP = params.BED_TEMP|default(60)|float %}
    {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(210)|float %}
    # Start bed heating (but don't wait for it) # This throws off eddy probe
    # M140 S{BED_TEMP}
    
    M190 S{BED_TEMP}               # Set and wait for bed to reach bed temp for Eddy Coil
    #M190 S110                     # Set and wait for bed to reach bed temp for Eddy Coil
    M109 S{EXTRUDER_TEMP}                # preheat extruder too

    G32                            ; prepare for printing                          
    G1 Z20 F3000                   ; move nozzle away from bed
   
    #M140 S{BED_TEMP}
    #M109 S{EXTRUDER_TEMP}          # Set and wait for nozzle to reach temperature
    PRIME_LINE                     # Pre-extrude from nozzle

[gcode_macro G32]
gcode:
    SAVE_GCODE_STATE NAME=STATE_G32
    G28                            ; home all axes
    QUAD_GANTRY_LEVEL              ; level the gantry
    #BED_MESH_CALIBRATE
    BED_MESH_CALIBRATE METHOD=rapid_scan ADAPTIVE=1 ;SCAN_MODE=rapid ; Eddy fast bed level scan
    #G28                            ; home all axes
    G90                            ; absolute positioning
    RESTORE_GCODE_STATE NAME=STATE_G32

[gcode_macro PRIME_LINE]
gcode: 
    M117 Prime Line
    G92 E0 ;Reset Extruder
    # move z axis 
    G1 Z2.0 F3000 ;Move Z Axis up
    # move to prime position 
    G1 X20 Y300 Z0.28 F5000.0 ;Move to start position
    G1 X20 Y50.0 Z0.28 F1500.0 E15 ;Draw the first line
    G1 X22 Y50.0 Z0.28 F5000.0 ;Move to side a little
    G1 X22 Y300 Z0.28 F1500.0 E30 ;Draw the second line
    G92 E0 ;Reset Extruder
    G1 Z2.0 F3000 ;Move Z Axis up

[gcode_macro PRINT_END]
#   Use PRINT_END for the slicer ending script - please customise for your slicer of choice
gcode:
    # safe anti-stringing move coords
    {% set th = printer.toolhead %}
    {% set x_safe = th.position.x + 20 * (1 if th.axis_maximum.x - th.position.x > 20 else -1) %}
    {% set y_safe = th.position.y + 20 * (1 if th.axis_maximum.y - th.position.y > 20 else -1) %}
    {% set z_safe = [th.position.z + 2, th.axis_maximum.z]|min %}
    
    SAVE_GCODE_STATE NAME=STATE_PRINT_END
    
    M400                           ; wait for buffer to clear
    G92 E0                         ; zero the extruder
    G1 E-5.0 F1800                 ; retract filament
    
    TURN_OFF_HEATERS
    
    G90                                      ; absolute positioning
    G0 X{x_safe} Y{y_safe} Z{z_safe} F20000  ; move nozzle to remove stringing
    G0 X{th.axis_maximum.x//2} Y{th.axis_maximum.y - 2} F3600  ; park nozzle at rear
    M107                                     ; turn off fan
    
    BED_MESH_CLEAR
    RESTORE_GCODE_STATE NAME=STATE_PRINT_END

[include moonraker_obico_macros.cfg]

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [probe_eddy_current btt_eddy]
#*# reg_drive_current = 15
#*# calibrate =
#*# 	0.050000:3259830.490,0.090000:3259357.093,0.130000:3258890.452,
#*# 	0.170000:3258431.429,0.210000:3257948.520,0.250000:3257521.944,
#*# 	0.290000:3257036.997,0.330000:3256633.846,0.370000:3256208.427,
#*# 	0.410000:3255807.733,0.450000:3255386.151,0.490000:3254933.782,
#*# 	0.530000:3254552.914,0.570000:3254157.381,0.610000:3253747.557,
#*# 	0.650000:3253381.105,0.690000:3252964.727,0.730000:3252585.933,
#*# 	0.770000:3252206.108,0.810000:3251863.612,0.850000:3251501.126,
#*# 	0.890000:3251163.754,0.930000:3250815.743,0.970000:3250472.281,
#*# 	1.010000:3250126.332,1.050000:3249789.637,1.090000:3249460.060,
#*# 	1.130000:3249146.558,1.170000:3248808.805,1.210000:3248491.375,
#*# 	1.250000:3248186.933,1.290000:3247905.709,1.330000:3247600.829,
#*# 	1.370000:3247297.386,1.410000:3247002.324,1.450000:3246695.090,
#*# 	1.490000:3246435.848,1.530000:3246163.894,1.570000:3245883.278,
#*# 	1.610000:3245635.487,1.650000:3245360.917,1.690000:3245087.274,
#*# 	1.730000:3244828.118,1.770000:3244579.419,1.810000:3244336.962,
#*# 	1.850000:3244092.034,1.890000:3243871.912,1.930000:3243631.985,
#*# 	1.970000:3243411.841,2.010000:3243169.420,2.050000:3242952.910,
#*# 	2.090000:3242723.875,2.130000:3242501.684,2.170000:3242271.328,
#*# 	2.210000:3242064.316,2.250000:3241862.073,2.290000:3241648.255,
#*# 	2.330000:3241459.143,2.370000:3241266.385,2.410000:3241056.179,
#*# 	2.450000:3240875.596,2.490000:3240673.566,2.530000:3240481.779,
#*# 	2.570000:3240316.749,2.610000:3240135.774,2.650000:3239969.796,
#*# 	2.690000:3239771.399,2.730000:3239584.880,2.770000:3239435.502,
#*# 	2.810000:3239244.720,2.850000:3239091.187,2.890000:3238937.991,
#*# 	2.930000:3238777.404,2.970000:3238614.192,3.010000:3238459.898,
#*# 	3.050000:3238265.596,3.090000:3238131.866,3.130000:3237981.338,
#*# 	3.170000:3237823.010,3.210000:3237711.250,3.250000:3237536.151,
#*# 	3.290000:3237395.137,3.330000:3237261.523,3.370000:3237106.488,
#*# 	3.410000:3236992.072,3.450000:3236870.592,3.490000:3236734.693,
#*# 	3.530000:3236610.806,3.570000:3236481.682,3.610000:3236349.544,
#*# 	3.650000:3236234.091,3.690000:3236102.147,3.730000:3235961.752,
#*# 	3.770000:3235868.197,3.810000:3235747.489,3.850000:3235628.786,
#*# 	3.890000:3235491.178,3.930000:3235380.001,3.970000:3235292.926,
#*# 	4.010000:3235157.738,4.050000:3235078.603
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  0.021474, 0.056706, 0.104742, 0.129546, 0.151300, 0.136870, 0.121505, 0.088847, 0.030353, -0.027534
#*# 	  -0.033157, 0.009955, 0.055981, 0.085833, 0.092875, 0.093275, 0.064847, 0.036058, -0.019692, -0.074320
#*# 	  -0.061868, -0.015141, 0.022770, 0.054212, 0.052316, 0.056919, 0.024179, -0.003724, -0.061718, -0.126759
#*# 	  -0.095366, -0.052321, -0.007955, 0.015167, 0.020809, 0.012050, -0.009052, -0.032736, -0.090488, -0.143213
#*# 	  -0.110559, -0.063308, -0.021069, 0.000509, 0.002784, -0.002617, -0.034418, -0.065509, -0.106662, -0.131405
#*# 	  -0.092962, -0.051069, -0.011851, 0.011962, 0.015167, 0.012228, -0.012270, -0.050214, -0.091028, -0.112902
#*# 	  -0.074189, -0.026273, 0.002763, 0.039422, 0.045780, 0.022338, 0.011794, -0.020860, -0.074318, -0.125142
#*# 	  -0.048282, -0.010434, 0.042881, 0.062915, 0.068172, 0.059278, 0.042408, 0.007563, -0.017896, -0.098429
#*# 	  -0.013764, 0.024611, 0.072149, 0.090554, 0.100316, 0.104237, 0.071242, 0.051349, 0.010815, -0.052720
#*# 	  -0.066567, -0.060471, -0.015141, -0.002979, 0.016928, 0.012775, 0.000941, -0.018315, -0.053716, -0.099042
#*# x_count = 10
#*# y_count = 10
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 30.0
#*# max_x = 334.92
#*# min_y = 30.0
#*# max_y = 334.92
